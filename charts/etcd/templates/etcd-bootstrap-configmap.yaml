---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.configMapName }}
  namespace: {{ .Release.Namespace }}
  labels:
    name: etcd
    instance: {{ .Values.name }}
{{- if .Values.labels }}
{{ toYaml .Values.labels | indent 4 }}
{{- end }}
  ownerReferences:
  - apiVersion: druid.gardener.cloud/v1alpha1
    blockOwnerDeletion: true
    controller: true
    kind: Etcd
    name: {{ .Values.name }}
    uid: {{ .Values.uid }}
data:
  bootstrap.sh: |-
    #!/bin/sh
    VALIDATION_MARKER=/var/etcd/data/validation_marker

{{- if .Values.etcd.enableTLS }}
    # install wget from apk in order to pass --ca-certificate flag because
    # busybox wget only has bare minimum features, without --ca-certificate option
    apk update
    if [ $? -ne 0 ]
    then
      echo "apk update failed"
      exit 1
    fi
    apk add wget
    if [ $? -ne 0 ]
    then
      echo "failed to update wget"
      exit 1
    fi
    # ensure that newly updated wget comes with --ca-certificate flag
    wget --help | grep -- --ca-certificate
    if [ $? -ne 0 ]
    then
      echo "updated wget is missing --ca-certificate flag"
      exit 1
    fi
{{- end }}

    trap_and_propagate() {
        PID=$1
        shift
        for sig in "$@" ; do
            trap "kill -$sig $PID" "$sig"
        done
    }

    start_managed_etcd(){
          rm -rf $VALIDATION_MARKER
          etcd --config-file /var/etcd/config/etcd.conf.yaml &
          ETCDPID=$!
          trap_and_propagate $ETCDPID INT TERM
          wait $ETCDPID
          RET=$?
          echo $RET > $VALIDATION_MARKER
          exit $RET
    }

    check_and_start_etcd(){
          while true;
          do
            wget {{ if .Values.etcd.enableTLS }}--ca-certificate=/var/etcd/ssl/ca/ca.crt "https{{ else }}"http{{ end }}://{{ .Values.name }}-local:{{ .Values.backup.port }}/initialization/status" -S -O status;
            STATUS=`cat status`;
            case $STATUS in
            "New")
                  wget {{ if .Values.etcd.enableTLS }}--ca-certificate=/var/etcd/ssl/ca/ca.crt "https{{ else }}"http{{ end }}://{{ .Values.name }}-local:{{ .Values.backup.port }}/initialization/start?mode=$1{{- if .Values.backup.failBelowRevision }}&failbelowrevision={{ int $.Values.backup.failBelowRevision }}{{- end }}" -S -O - ;;
            "Progress")
                  sleep 1;
                  continue;;
            "Failed")
                  continue;;
            "Successful")
                  echo "Bootstrap preprocessing end time: $(date)"
                  start_managed_etcd
                  break
                  ;;
            esac;
          done
    }

    echo "Bootstrap preprocessing start time: $(date)"
    if [ ! -f $VALIDATION_MARKER ] ;
    then
          echo "No $VALIDATION_MARKER file. Perform complete initialization routine and start etcd."
          check_and_start_etcd full
    else
          echo "$VALIDATION_MARKER file present. Check return status and decide on initialization"
          run_status=`cat $VALIDATION_MARKER`
          echo "$VALIDATION_MARKER content: $run_status"
          if [ $run_status == '143' ] || [ $run_status == '130' ] || [ $run_status == '0' ] ; then
                echo "Requesting sidecar to perform sanity validation"
                check_and_start_etcd sanity
          else
                echo "Requesting sidecar to perform full validation"
                check_and_start_etcd full
          fi
    fi
  etcd.conf.yaml: |-
    # Human-readable name for this member.
    name: etcd-{{ printf "%.6s" .Values.uid }}

    # Path to the data directory.
    data-dir: /var/etcd/data/new.etcd

    # metrics configuration
    metrics: {{ .Values.etcd.metrics }}

    # Number of committed transactions to trigger a snapshot to disk.
    snapshot-count: 75000

    # Accept etcd V2 client requests
    enable-v2: false

    # Raise alarms when backend size exceeds the given quota. 0 means use the
    # default quota.
    {{- if .Values.backup.etcdQuotaBytes }}
    quota-backend-bytes: {{ int $.Values.backup.etcdQuotaBytes }}
    {{- end }}

    # List of comma separated URLs to listen on for client traffic.
    listen-client-urls: {{ if .Values.etcd.enableTLS }}https{{ else }}http{{ end }}://0.0.0.0:{{ .Values.etcd.clientPort }}

    # List of this member's client URLs to advertise to the public.
    # The URLs needed to be a comma-separated list.
    advertise-client-urls: {{ if .Values.etcd.enableTLS }}https{{ else }}http{{ end }}://0.0.0.0:{{ .Values.etcd.clientPort }}

    # Initial cluster token for the etcd cluster during bootstrap.
    initial-cluster-token: {{ .Values.etcd.initialClusterToken }}

    # Initial cluster state ('new' or 'existing').
    initial-cluster-state: {{ .Values.etcd.initialClusterState }}

    # keep one day of history
    auto-compaction-mode: periodic
    auto-compaction-retention: "24"

{{- if .Values.etcd.enableTLS }}
    client-transport-security:
      # Path to the client server TLS cert file.
      cert-file: /var/etcd/ssl/server/tls.crt

      # Path to the client server TLS key file.
      key-file: /var/etcd/ssl/server/tls.key

      # Enable client cert authentication.
      client-cert-auth: true

      # Path to the client server TLS trusted CA cert file.
      trusted-ca-file: /var/etcd/ssl/ca/ca.crt

      # Client TLS using generated certificates
      auto-tls: false
{{- end }}

  etcdbr.conf.yaml: |-
    etcdConnectionConfig:
{{- if .Values.etcd.enableTLS }}
        # username: admin
        # password: admin
        endpoints:
          - https://{{ .Values.name }}-local:{{ .Values.etcd.clientPort }}
        connectionTimeout: {{ .Values.backup.etcdConnectionTimeout }}
        insecureTransport: false
        insecureSkipVerify: false
        certFile: /var/etcd/ssl/client/tls.crt
        keyFile: /var/etcd/ssl/client/tls.key
        caFile: /var/etcd/ssl/client/ca.crt
{{ else }}
        endpoints:
          - http://{{ .Values.name }}-local:{{ .Values.etcd.clientPort }}
{{- end }}
    serverConfig:
        port: 8080
        # enableProfiling: true
{{- if .Values.etcd.enableTLS }}
        server-cert: /var/etcd/ssl/server/tls.crt
        server-key: /var/etcd/ssl/server/tls.key
{{- end }}
    snapshotterConfig:
{{-if .Values.backup.fullSnapshotSchedule }}
        schedule: {{ .Values.backup.fullSnapshotSchedule }}
{{- end }}
{{- if .Values.backup.deltaSnapshotPeriod }}
        deltaSnapshotPeriod: {{ .Values.backup.deltaSnapshotPeriod }}
{{- end }}
{{- if .Values.backup.deltaSnapshotMemoryLimit }}
        deltaSnapshotMemoryLimit: {{ int $.Values.backup.deltaSnapshotMemoryLimit }}
{{- end }}
{{- if .Values.backup.garbageCollectionPeriod }}
        garbageCollectionPeriod: {{ .Values.backup.garbageCollectionPeriod }}
{{- end}}
{{- if .Values.backup.garbageCollectionPolicy }}
        garbageCollectionPolicy: {{ .Values.backup.garbageCollectionPolicy }}
{{- end }}
{{- if eq .Values.backup.garbageCollectionPolicy "LimitBased" and .Values.backup.maxBackups }}
        maxBackups: {{ int $.Values.backup.maxBackups }}
{{- end }}
{{- if .Values.store.storageProvider }}
    snapstoreConfig:
        provider: {{ .Values.store.storageProvider }}
        # container: "backup"
{{- if .Values.store.storePrefix }}
        prefix: {{ .Values.store.storePrefix }}
{{- end }}
        # maxParallelChunkUploads: 5
        tempDir: {{ .Values.backup.snapstoreTempDir }}
{{- end }}
    restorationConfig:
        initialCluster: "default=http://localhost:2380"
        initialClusterToken: "etcd-cluster"
        restoreDataDir: /var/etcd/data/new.etcd
        initialAdvertisePeerURLs:
            - "http://localhost:2380"
        name: "default"
        skipHashCheck: false
        maxFetchers: 6
{{- if .Values.backup.etcdQuotaBytes }}
        embeddedEtcdQuotaBytes: {{ int $.Values.backup.etcdQuotaBytes }}
{{- end }}
{{-if .Values.etcd.defragmentationSchedule }}
    defragmentationSchedule: {{ .Values.etcd.defragmentationSchedule }}
{{- end }}